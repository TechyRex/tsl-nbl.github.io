<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSL - Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-truck-moving fa-2x"></i>
                <div>
                    <h1>TSL Logistics</h1>
                    <p>Admin Dashboard</p>
                </div>
            </div>
            <nav class="main-nav">
                <a href="index.html" class="nav-link"><i class="fas fa-home"></i> Home</a>
                <a href="code-generator.html" class="nav-link"><i class="fas fa-key"></i> Code Generator</a>
                <a href="admin-dashboard.html" class="nav-link active"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a href="user-input.html" class="nav-link"><i class="fas fa-edit"></i> Input Data</a>
                <a href="#" class="nav-link" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </nav>
        </div>
    </div>

    <div class="container">
        <div class="dashboard-header">
            <div class="dashboard-title">
                <h2><i class="fas fa-tachometer-alt"></i> Shortage Analytics Dashboard</h2>
                <p>Real-time tracking and analysis of delivery shortages</p>
            </div>
            <div class="dashboard-controls">
                <select id="timeFilter" class="form-control" onchange="filterData()">
                    <option value="month">This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                    <option value="all">All Time</option>
                </select>
                <button class="btn btn-secondary" onclick="exportData()">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #0033a0;">
                    <i class="fas fa-truck"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalTrips">0</h3>
                    <p>Total Trips</p>
                    <small id="tripsChange" class="positive">+0% from last month</small>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #e31837;">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalShortage">₦0</h3>
                    <p>Total Shortage Value</p>
                    <small id="shortageChange" class="negative">+0% from last month</small>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #ffc107;">
                    <i class="fas fa-user-friends"></i>
                </div>
                <div class="stat-info">
                    <h3 id="activeDrivers">0</h3>
                    <p>Active Drivers</p>
                    <small id="driversChange" class="neutral">0 this month</small>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background-color: #28a745;">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="stat-info">
                    <h3 id="shortageRate">0%</h3>
                    <p>Shortage Rate</p>
                    <small id="rateChange" class="positive">+0% from last month</small>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-row">
                <div class="chart-card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-line"></i> Monthly Shortage Trend</h3>
                        <select id="chartType" class="form-control-sm" onchange="updateChartType()">
                            <option value="line">Line Chart</option>
                            <option value="bar">Bar Chart</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="card-header">
                        <h3><i class="fas fa-user-chart"></i> Top 5 Drivers by Shortage</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="driverChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chart-row">
                <div class="chart-card">
                    <div class="card-header">
                        <h3><i class="fas fa-map-marker-alt"></i> Shortage by Destination</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="locationChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="chart-card">
                    <div class="card-header">
                        <h3><i class="fas fa-box"></i> Shortage by Product Type</h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="productChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-search"></i> Search & Filter</h3>
            </div>
            <div class="card-body">
                <div class="search-filters">
                    <div class="filter-group">
                        <input type="text" 
                               id="searchDriver" 
                               class="form-control" 
                               placeholder="Search by driver name..."
                               onkeyup="searchDrivers()">
                    </div>
                    <div class="filter-group">
                        <input type="date" 
                               id="dateFrom" 
                               class="form-control" 
                               onchange="filterData()">
                    </div>
                    <div class="filter-group">
                        <input type="date" 
                               id="dateTo" 
                               class="form-control" 
                               onchange="filterData()">
                    </div>
                    <div class="filter-group">
                        <select id="liabilityFilter" class="form-control" onchange="filterData()">
                            <option value="all">All Liability</option>
                            <option value="liable">Liable Only</option>
                            <option value="not-liable">Not Liable</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Driver Performance Table -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-users"></i> Driver Performance Summary</h3>
                <div class="table-actions">
                    <button class="btn btn-sm btn-secondary" onclick="sortTable('driver', 'asc')">
                        <i class="fas fa-sort-alpha-down"></i> Sort A-Z
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="sortTable('shortage', 'desc')">
                        <i class="fas fa-sort-amount-down"></i> Sort by Shortage
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="data-table" id="driverTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable('driver', '')">Driver Name</th>
                                <th onclick="sortTable('trips', '')">Trips</th>
                                <th onclick="sortTable('loaded', '')">Total Loaded</th>
                                <th onclick="sortTable('received', '')">Total Received</th>
                                <th onclick="sortTable('shortage', '')">Total Shortage (₦)</th>
                                <th onclick="sortTable('liable', '')">Liable Amount (₦)</th>
                                <th onclick="sortTable('rate', '')">Shortage Rate</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="driverTableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="table-footer">
                    <div class="pagination" id="pagination">
                        <!-- Pagination will be generated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Shortages -->
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-history"></i> Recent Shortage Reports</h3>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Shipment No.</th>
                                <th>Driver</th>
                                <th>Customer</th>
                                <th>Loaded</th>
                                <th>Received</th>
                                <th>Shortage (₦)</th>
                                <th>Liability</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentShortages">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Driver Detail Modal -->
        <div id="driverModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalDriverName">Driver Details</h3>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="driver-stats">
                        <div class="driver-stat">
                            <h4>Total Trips</h4>
                            <p id="modalTotalTrips">0</p>
                        </div>
                        <div class="driver-stat">
                            <h4>Total Shortage</h4>
                            <p id="modalTotalShortage">₦0</p>
                        </div>
                        <div class="driver-stat">
                            <h4>Liable Amount</h4>
                            <p id="modalLiableAmount">₦0</p>
                        </div>
                        <div class="driver-stat">
                            <h4>Shortage Rate</h4>
                            <p id="modalShortageRate">0%</p>
                        </div>
                    </div>
                    <div class="driver-trips">
                        <h4>Recent Trips</h4>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Shipment</th>
                                        <th>Customer</th>
                                        <th>Shortage</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="modalDriverTrips">
                                    <!-- Trips will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                    <button class="btn btn-primary" onclick="generateDriverReport()">
                        <i class="fas fa-file-pdf"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>TSL Logistics &copy; 2023 - Nigeria's Premier Logistics and Transportation Services Provider</p>
        <p>Strategic Hubs: Lagos, Ogun, and Cross River States | BBB Credit Rating (Augusto 2019)</p>
    </footer>

    <div id="notificationContainer"></div>

    <script src="script.js"></script>
    <script>
        // Dashboard specific JavaScript
        let monthlyChart, driverChart, locationChart, productChart;
        let filteredData = [];
        let currentSort = { column: '', direction: 'asc' };
        let currentPage = 1;
        const itemsPerPage = 10;

        document.addEventListener('DOMContentLoaded', function() {
            // Set default date range (last 30 days)
            const today = new Date();
            const lastMonth = new Date(today);
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            
            document.getElementById('dateFrom').value = lastMonth.toISOString().split('T')[0];
            document.getElementById('dateTo').value = today.toISOString().split('T')[0];
            
            // Initialize dashboard
            loadDashboardData();
            initCharts();
            updateDashboard();
        });

        async function loadDashboardData() {
            try {
                // In production, this would fetch from SheetDB
                // const response = await axios.get('YOUR_SHEETDB_ENDPOINT');
                // filteredData = response.data;
                
                // For demo, use sample data
                filteredData = [...sampleData];
                updateDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Failed to load dashboard data', 'error');
            }
        }

        function updateDashboard() {
            updateKPIs();
            updateDriverTable();
            updateRecentShortages();
            updateCharts();
        }

        function updateKPIs() {
            const totalTrips = filteredData.length;
            const totalShortage = filteredData.reduce((sum, item) => sum + (item.totalShortage || 0), 0);
            const activeDrivers = new Set(filteredData.map(item => item.driverName)).size;
            const totalLoaded = filteredData.reduce((sum, item) => sum + (item.quantityLoaded || 0), 0);
            const totalReceived = filteredData.reduce((sum, item) => sum + (item.quantityReceived || 0), 0);
            const shortageRate = totalLoaded > 0 ? ((totalLoaded - totalReceived) / totalLoaded * 100).toFixed(1) : 0;

            document.getElementById('totalTrips').textContent = totalTrips.toLocaleString();
            document.getElementById('totalShortage').textContent = `₦${totalShortage.toLocaleString()}`;
            document.getElementById('activeDrivers').textContent = activeDrivers;
            document.getElementById('shortageRate').textContent = `${shortageRate}%`;
        }

        function initCharts() {
            const ctx1 = document.getElementById('monthlyChart').getContext('2d');
            const ctx2 = document.getElementById('driverChart').getContext('2d');
            const ctx3 = document.getElementById('locationChart').getContext('2d');
            const ctx4 = document.getElementById('productChart').getContext('2d');

            // Monthly Chart
            monthlyChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Shortage Value (₦)',
                        data: [],
                        borderColor: '#0033a0',
                        backgroundColor: 'rgba(0, 51, 160, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: getChartOptions('Monthly Shortage Trend')
            });

            // Driver Chart
            driverChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Shortage (₦)',
                        data: [],
                        backgroundColor: '#e31837',
                        borderColor: '#b8142c',
                        borderWidth: 1
                    }]
                },
                options: getChartOptions('Driver Shortage Comparison')
            });

            // Location Chart
            locationChart = new Chart(ctx3, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Shortage by Location',
                        data: [],
                        backgroundColor: [
                            '#0033a0', '#e31837', '#ffc107', '#28a745', '#17a2b8',
                            '#6c757d', '#6610f2', '#fd7e14', '#20c997', '#dc3545'
                        ]
                    }]
                },
                options: getChartOptions('Shortage Distribution by Location')
            });

            // Product Chart
            productChart = new Chart(ctx4, {
                type: 'polarArea',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Shortage by Product',
                        data: [],
                        backgroundColor: [
                            'rgba(0, 51, 160, 0.7)',
                            'rgba(227, 24, 55, 0.7)',
                            'rgba(255, 193, 7, 0.7)',
                            'rgba(40, 167, 69, 0.7)',
                            'rgba(23, 162, 184, 0.7)'
                        ]
                    }]
                },
                options: getChartOptions('Shortage by Product Type')
            });
        }

        function updateCharts() {
            updateMonthlyChart();
            updateDriverChart();
            updateLocationChart();
            updateProductChart();
        }

        function updateMonthlyChart() {
            const monthlyData = {};
            
            filteredData.forEach(item => {
                const date = new Date(item.date);
                const monthYear = date.toLocaleString('default', { month: 'short' }) + ' ' + date.getFullYear();
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = 0;
                }
                
                monthlyData[monthYear] += item.totalShortage || 0;
            });

            const labels = Object.keys(monthlyData);
            const data = labels.map(label => monthlyData[label]);

            monthlyChart.data.labels = labels;
            monthlyChart.data.datasets[0].data = data;
            monthlyChart.update();
        }

        function updateDriverChart() {
            const driverShortages = {};
            
            filteredData.forEach(item => {
                if (!driverShortages[item.driverName]) {
                    driverShortages[item.driverName] = 0;
                }
                driverShortages[item.driverName] += item.totalShortage || 0;
            });

            // Get top 5 drivers
            const topDrivers = Object.entries(driverShortages)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const labels = topDrivers.map(([driver]) => driver.split(' ')[0]);
            const data = topDrivers.map(([, shortage]) => shortage);

            driverChart.data.labels = labels;
            driverChart.data.datasets[0].data = data;
            driverChart.update();
        }

        function updateLocationChart() {
            const locationData = {};
            
            filteredData.forEach(item => {
                const location = item.customerName || 'Unknown';
                if (!locationData[location]) {
                    locationData[location] = 0;
                }
                locationData[location] += item.totalShortage || 0;
            });

            // Get top 5 locations
            const topLocations = Object.entries(locationData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const labels = topLocations.map(([location]) => location);
            const data = topLocations.map(([, shortage]) => shortage);

            locationChart.data.labels = labels;
            locationChart.data.datasets[0].data = data;
            locationChart.update();
        }

        function updateProductChart() {
            const productData = {};
            
            filteredData.forEach(item => {
                const product = item.productDescription || 'Unknown Product';
                if (!productData[product]) {
                    productData[product] = 0;
                }
                productData[product] += item.totalShortage || 0;
            });

            // Get top 5 products
            const topProducts = Object.entries(productData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const labels = topProducts.map(([product]) => product.substring(0, 20) + '...');
            const data = topProducts.map(([, shortage]) => shortage);

            productChart.data.labels = labels;
            productChart.data.datasets[0].data = data;
            productChart.update();
        }

        function updateDriverTable() {
            const driverStats = {};
            
            // Calculate statistics for each driver
            filteredData.forEach(item => {
                const driver = item.driverName;
                if (!driverStats[driver]) {
                    driverStats[driver] = {
                        trips: 0,
                        totalLoaded: 0,
                        totalReceived: 0,
                        totalShortage: 0,
                        liableAmount: 0
                    };
                }
                
                driverStats[driver].trips++;
                driverStats[driver].totalLoaded += item.quantityLoaded || 0;
                driverStats[driver].totalReceived += item.quantityReceived || 0;
                driverStats[driver].totalShortage += item.totalShortage || 0;
                driverStats[driver].liableAmount += item.liableAmount || 0;
            });

            // Convert to array and sort
            let driverArray = Object.entries(driverStats).map(([driver, stats]) => ({
                driver,
                ...stats,
                shortageRate: stats.totalLoaded > 0 ? 
                    ((stats.totalLoaded - stats.totalReceived) / stats.totalLoaded * 100).toFixed(1) : 0
            }));

            // Apply sorting
            if (currentSort.column) {
                driverArray.sort((a, b) => {
                    let aValue = a[currentSort.column];
                    let bValue = b[currentSort.column];
                    
                    if (currentSort.column === 'driver') {
                        aValue = aValue.toLowerCase();
                        bValue = bValue.toLowerCase();
                    }
                    
                    if (currentSort.direction === 'asc') {
                        return aValue > bValue ? 1 : -1;
                    } else {
                        return aValue < bValue ? 1 : -1;
                    }
                });
            }

            // Pagination
            const totalPages = Math.ceil(driverArray.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedDrivers = driverArray.slice(startIndex, endIndex);

            // Update table
            const tableBody = document.getElementById('driverTableBody');
            tableBody.innerHTML = '';

            paginatedDrivers.forEach(driver => {
                const row = document.createElement('tr');
                const status = getDriverStatus(driver);
                
                row.innerHTML = `
                    <td><strong>${driver.driver}</strong></td>
                    <td>${driver.trips}</td>
                    <td>${driver.totalLoaded.toLocaleString()}</td>
                    <td>${driver.totalReceived.toLocaleString()}</td>
                    <td><span class="badge badge-danger">₦${driver.totalShortage.toLocaleString()}</span></td>
                    <td>₦${driver.liableAmount.toLocaleString()}</td>
                    <td>${driver.shortageRate}%</td>
                    <td><span class="badge ${status.class}">${status.text}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewDriverDetails('${driver.driver}')">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Update pagination
            updatePagination(totalPages);
        }

        function getDriverStatus(driver) {
            const avgShortage = driver.totalShortage / driver.trips;
            
            if (avgShortage > 50000) {
                return { class: 'badge-danger', text: 'High Risk' };
            } else if (avgShortage > 25000) {
                return { class: 'badge-warning', text: 'Medium Risk' };
            } else if (avgShortage > 10000) {
                return { class: 'badge-info', text: 'Low Risk' };
            } else {
                return { class: 'badge-success', text: 'Good' };
            }
        }

        function updatePagination(totalPages) {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            if (currentPage > 1) {
                const prevBtn = document.createElement('button');
                prevBtn.className = 'btn btn-sm btn-secondary';
                prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevBtn.onclick = () => {
                    currentPage--;
                    updateDriverTable();
                };
                paginationDiv.appendChild(prevBtn);
            }

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-secondary'}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => {
                        currentPage = i;
                        updateDriverTable();
                    };
                    paginationDiv.appendChild(pageBtn);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'pagination-ellipsis';
                    paginationDiv.appendChild(ellipsis);
                }
            }

            // Next button
            if (currentPage < totalPages) {
                const nextBtn = document.createElement('button');
                nextBtn.className = 'btn btn-sm btn-secondary';
                nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextBtn.onclick = () => {
                    currentPage++;
                    updateDriverTable();
                };
                paginationDiv.appendChild(nextBtn);
            }
        }

        function updateRecentShortages() {
            const tableBody = document.getElementById('recentShortages');
            tableBody.innerHTML = '';

            // Get recent shortages (last 10)
            const recentData = [...filteredData]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);

            recentData.forEach(item => {
                const row = document.createElement('tr');
                const shortage = item.totalShortage || 0;
                const liability = item.driversLiable === 'Yes' ? 'Liable' : 'Not Liable';
                const statusClass = liability === 'Liable' ? 'badge-danger' : 'badge-warning';
                
                row.innerHTML = `
                    <td>${item.date}</td>
                    <td><code>${item.shipmentNumber}</code></td>
                    <td>${item.driverName}</td>
                    <td>${item.customerName || 'N/A'}</td>
                    <td>${item.quantityLoaded || 0}</td>
                    <td>${item.quantityReceived || 0}</td>
                    <td><strong>₦${shortage.toLocaleString()}</strong></td>
                    <td><span class="badge ${statusClass}">${liability}</span></td>
                    <td>
                        <span class="badge ${shortage > 50000 ? 'badge-danger' : shortage > 20000 ? 'badge-warning' : 'badge-info'}">
                            ${shortage > 50000 ? 'High' : shortage > 20000 ? 'Medium' : 'Low'}
                        </span>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function searchDrivers() {
            const searchTerm = document.getElementById('searchDriver').value.toLowerCase();
            const rows = document.querySelectorAll('#driverTableBody tr');
            
            rows.forEach(row => {
                const driverName = row.cells[0].textContent.toLowerCase();
                if (driverName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function filterData() {
            const timeFilter = document.getElementById('timeFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const liabilityFilter = document.getElementById('liabilityFilter').value;

            let filtered = [...sampleData];

            // Apply time filter
            if (timeFilter !== 'all') {
                const now = new Date();
                const filterDate = new Date();
                
                switch (timeFilter) {
                    case 'month':
                        filterDate.setMonth(filterDate.getMonth() - 1);
                        break;
                    case 'quarter':
                        filterDate.setMonth(filterDate.getMonth() - 3);
                        break;
                    case 'year':
                        filterDate.setFullYear(filterDate.getFullYear() - 1);
                        break;
                }
                
                filtered = filtered.filter(item => {
                    const itemDate = new Date(item.date);
                    return itemDate >= filterDate;
                });
            }

            // Apply date range filter
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filtered = filtered.filter(item => new Date(item.date) >= fromDate);
            }
            
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filtered = filtered.filter(item => new Date(item.date) <= toDate);
            }

            // Apply liability filter
            if (liabilityFilter !== 'all') {
                filtered = filtered.filter(item => {
                    if (liabilityFilter === 'liable') {
                        return item.driversLiable === 'Yes';
                    } else {
                        return item.driversLiable !== 'Yes';
                    }
                });
            }

            filteredData = filtered;
            currentPage = 1;
            updateDashboard();
        }

        function sortTable(column, direction) {
            if (direction) {
                currentSort = { column, direction };
            } else {
                // Toggle sort direction if same column
                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort = { column, direction: 'desc' };
                }
            }
            
            updateDriverTable();
        }

        function viewDriverDetails(driverName) {
            // Filter trips for this driver
            const driverTrips = filteredData.filter(item => item.driverName === driverName);
            
            // Calculate statistics
            const totalTrips = driverTrips.length;
            const totalShortage = driverTrips.reduce((sum, trip) => sum + (trip.totalShortage || 0), 0);
            const liableAmount = driverTrips.reduce((sum, trip) => sum + (trip.liableAmount || 0), 0);
            const totalLoaded = driverTrips.reduce((sum, trip) => sum + (trip.quantityLoaded || 0), 0);
            const totalReceived = driverTrips.reduce((sum, trip) => sum + (trip.quantityReceived || 0), 0);
            const shortageRate = totalLoaded > 0 ? ((totalLoaded - totalReceived) / totalLoaded * 100).toFixed(1) : 0;

            // Update modal
            document.getElementById('modalDriverName').textContent = driverName;
            document.getElementById('modalTotalTrips').textContent = totalTrips;
            document.getElementById('modalTotalShortage').textContent = `₦${totalShortage.toLocaleString()}`;
            document.getElementById('modalLiableAmount').textContent = `₦${liableAmount.toLocaleString()}`;
            document.getElementById('modalShortageRate').textContent = `${shortageRate}%`;

            // Update trips table
            const tripsTable = document.getElementById('modalDriverTrips');
            tripsTable.innerHTML = '';

            driverTrips.slice(0, 5).forEach(trip => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${trip.date}</td>
                    <td>${trip.shipmentNumber}</td>
                    <td>${trip.customerName || 'N/A'}</td>
                    <td>₦${(trip.totalShortage || 0).toLocaleString()}</td>
                    <td>
                        <span class="badge ${trip.driversLiable === 'Yes' ? 'badge-danger' : 'badge-warning'}">
                            ${trip.driversLiable === 'Yes' ? 'Liable' : 'Review'}
                        </span>
                    </td>
                `;
                tripsTable.appendChild(row);
            });

            // Show modal
            document.getElementById('driverModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('driverModal').style.display = 'none';
        }

        function generateDriverReport() {
            const driverName = document.getElementById('modalDriverName').textContent;
            showNotification(`Generating report for ${driverName}...`, 'info');
            // In production, this would generate a PDF report
        }

        function exportData() {
            // Create CSV content
            let csvContent = "Date,Shipment No,Driver,Customer,Loaded,Received,Shortage,Liability\n";
            
            filteredData.forEach(item => {
                const row = [
                    item.date,
                    item.shipmentNumber,
                    `"${item.driverName}"`,
                    `"${item.customerName || ''}"`,
                    item.quantityLoaded || 0,
                    item.quantityReceived || 0,
                    item.totalShortage || 0,
                    item.driversLiable || 'No'
                ];
                csvContent += row.join(',') + '\n';
            });

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tsl-shortage-report-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('Data exported successfully!', 'success');
        }

        function updateChartType() {
            const type = document.getElementById('chartType').value;
            monthlyChart.config.type = type;
            monthlyChart.update();
        }

        function getChartOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: title,
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000) {
                                    return '₦' + (value / 1000000).toFixed(1) + 'M';
                                } else if (value >= 1000) {
                                    return '₦' + (value / 1000).toFixed(0) + 'K';
                                }
                                return '₦' + value;
                            }
                        }
                    }
                }
            };
        }

        function logout() {
            showNotification('Logged out successfully', 'success');
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('driverModal');
            if (event.target === modal) {
                closeModal();
            }
        };
    </script>

    <style>
        /* Dashboard specific styles */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .dashboard-title h2 {
            color: var(--primary);
            margin-bottom: 5px;
        }

        .dashboard-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .charts-section {
            margin: 30px 0;
        }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1100px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            height: 350px;
        }

        .chart-container {
            height: 280px;
            width: 100%;
        }

        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .table-footer {
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }

        .pagination {
            display: flex;
            gap: 5px;
        }

        .pagination-ellipsis {
            padding: 5px 10px;
            display: flex;
            align-items: center;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: var(--border-radius);
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .driver-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .driver-stat {
            text-align: center;
            padding: 15px;
            background: var(--light);
            border-radius: var(--border-radius);
        }

        .driver-stat h4 {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .driver-stat p {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin: 0;
        }

        .driver-trips {
            margin-top: 30px;
        }

        .modal-footer {
            padding: 20px;
            background: var(--light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-control-sm {
            padding: 5px 10px;
            font-size: 14px;
        }

        .positive { color: var(--success); }
        .negative { color: var(--danger); }
        .neutral { color: var(--gray); }
    </style>
</body>
</html>
